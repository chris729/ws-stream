<html>
  <head>
    <title>fMp4 Test</title>
	<link href="//vjs.zencdn.net/7.3.0/video-js.min.css" rel="stylesheet">
<script src="//vjs.zencdn.net/7.3.0/video.min.js"></script>
  </head>
  <body>
 <video
    id="my-player"
    class="video-js" 
    controls
	muted
	autoplay
    data-setup='{}'>
  <p class="vjs-no-js">
    To view this video please enable JavaScript, and consider upgrading to a
    web browser that
    <a href="https://videojs.com/html5-video-support/" target="_blank">
      supports HTML5 video
    </a>
  </p>
</video>
	
    <script src="js/mux.js"></script>
    <script>
		// Create array for fmp4
		var segments = [];
		var i =0;

		// set up websocket
		let HOST = location.origin.replace(/^http/, 'ws');
		let websocket = new WebSocket(HOST);
		websocket.binaryType = 'arraybuffer';

		// set up media source
		const mime = 'video/mp4; codecs="avc1.42C01F"';
		let mediaSource = new MediaSource();
		video = document.querySelector('video');
		video.src = URL.createObjectURL(mediaSource);
		var player = videojs('my-player');
		player.play();
		
		var sourceBuffer = {"updating" : true};
		mediaSource.addEventListener("sourceopen", wait);
		
		// muxer is only used for debugging data type with inspect tool
		var transmuxer = new muxjs.mp4.Transmuxer();
		
		// append with a special init header
		function appendFirstSegment(){
			URL.revokeObjectURL(video.src);
			sourceBuffer = mediaSource.addSourceBuffer(mime);
			ftype = segments.shift();
			moov = segments.shift();
			init = new Uint8Array(ftype.byteLength + moov.byteLength);
			init.set(ftype,0);
			init.set(moov,ftype.byteLength);
			
			// console.log(muxjs.mp4.tools.inspect(init));
			sourceBuffer.appendBuffer(init);
			sourceBuffer.addEventListener('update', appendNextSegment);
			
			//--------------------- debugging ---------------
			sourceBuffer.addEventListener('updatestart', e=> { console.log('updatestart: ' + mediaSource.readyState); });
			sourceBuffer.addEventListener('update', e=> { console.log('update: ' + mediaSource.readyState); });
			sourceBuffer.addEventListener('updateend', e=> { console.log('updateend: ' + mediaSource.readyState); });
			sourceBuffer.addEventListener('error', e=> { console.log('error: ' + mediaSource.readyState); });
			sourceBuffer.addEventListener('abort', e=> { console.log('abort: ' + mediaSource.readyState); });
		}
		
		// then just append normally 
		function appendNextSegment(){
			if (segments.length > 0 && !sourceBuffer.updating){
				next = segments.shift();
				next = new Uint8Array(next);
				sourceBuffer.appendBuffer(next);
				console.log("Buffered segments: " + segments.length);
			}
		}
		
		// timeout until init segments have been recieved
		function wait(){
			if (segments.length > 2) {	
				appendFirstSegment();
			}
			else {
			setTimeout(wait, 1);
			}
		}; 

		// websocket message actions 
		websocket.onmessage = e => {
			data = new Uint8Array(e.data);
			if(sourceBuffer.updating || segments.length > 0){
				segments.push(data);
				console.log("Buffered segments: " + segments.length);
			}else{
				//console.log(muxjs.mp4.tools.inspect(data));
				sourceBuffer.appendBuffer(data);
			}
		};
		
		//--------------------- debugging ---------------
		mediaSource.addEventListener('sourceopen', e=> { console.log('sourceopen: ' + mediaSource.readyState); });
		mediaSource.addEventListener('sourceended', e=> { console.log('sourceended: ' + mediaSource.readyState); });
		mediaSource.addEventListener('sourceclose', e=> { console.log('sourceclose: ' + mediaSource.readyState); });
		mediaSource.addEventListener('error', e=> { console.log('error: ' + mediaSource.readyState); });
    </script>
  </body>
</html>

